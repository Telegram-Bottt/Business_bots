# Telegram Bot - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

## üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –±–∞–≥–∏

### 1Ô∏è‚É£ ‚è∞ –ë–∞–≥ —Å –ø–æ—Ç–µ—Ä–µ–π –≤—Ä–µ–º–µ–Ω–∏ (time = 00)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—ã–±–∏—Ä–∞—é –≤—Ä–µ–º—è 11:00 ‚Üí –≤ –ë–î —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è "00"

**–ü—Ä–∏—á–∏–Ω–∞:** `split(':')[-1]` –¥–∞–≤–∞–ª —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω—é—é —á–∞—Å—Ç—å —Å—Ç—Ä–æ–∫–∏. –ü—Ä–∏ `book:time:11:00` –ø–æ–ª—É—á–∞–ª–æ—Å—å "00"

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ë—ã–ª–æ:
time_s = query.data.split(':')[-1]  # ‚Üí "00"

# –¢–µ–ø–µ—Ä—å:
parts = query.data.split(':')
time_s = ':'.join(parts[-2:])  # ‚Üí "11:00"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –†–∞—Å–ø—Ä–µ–¥–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∫–∞–∫ `HH:MM` —Å—Ç—Ä–æ–∫–∞ ‚úÖ

---

### 2Ô∏è‚É£ üö´ –ü—Ä–æ—à–µ–¥—à–∏–µ —Å–ª–æ—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 09:00 –∏ 10:00, —Ö–æ—Ç—è —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è 10:46

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ `generate_slots()`:**
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
today = datetime.now().date().isoformat()
now_min = hhmm_to_minutes(datetime.now().strftime('%H:%M'))

# –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª–æ—Ç—ã –≤ –ø—Ä–æ—à–ª–æ–º
if date_s == today and cand_end <= now_min:
    continue
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–∞ —Å–µ–≥–æ–¥–Ω—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –±—É–¥—É—â–∏–µ —Å–ª–æ—Ç—ã ‚úÖ

---

### 3Ô∏è‚É£ ‚ö° –ê–≤—Ç–æ–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–µ–∞–Ω—Å –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü—Ä–∏—á–∏–Ω–∞:** `delay = max(0, delay_seconds)` –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª –∑–∞–¥–∞—á—É –Ω–∞ 0 —Å–µ–∫—É–Ω–¥

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ë—ã–ª–æ:
if delay < 0:
    delay = 0
task = asyncio.create_task(_auto_complete(booking_id, delay))  # ‚Üí immediate!

# –¢–µ–ø–µ—Ä—å:
if delay <= 0:
    logger.info("auto_complete_skip: scheduled_time_in_past")
    return  # –ù–µ –ø–ª–∞–Ω–∏—Ä—É–µ–º –≤–æ–æ–±—â–µ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ê–≤—Ç–æ–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–æ–≤–Ω–æ –≤ (–≤—Ä–µ–º—è + –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å + grace_period) ‚úÖ

---

### 4Ô∏è‚É£ üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–ü—Ä–æ–±–ª–µ–º–∞:** 
- "–ó–∞–≤—Ç—Ä–∞ –∑–∞–ø–∏—Å—å" –ø—Ä–∏—Ö–æ–¥–∏—Ç –¥–∞–∂–µ –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å —Å–µ–≥–æ–¥–Ω—è ‚Üí –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å—Ä–∞–∑—É
- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –µ—Å–ª–∏ –≤—Ä–µ–º—è —É–∂–µ –ø—Ä–æ—à–ª–æ

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ –ø—Ä–æ—à–ª–æ–º
for kind in ('24h', '1h'):
    run_at = times[kind]
    delay = (run_at - now).total_seconds()
    
    if delay <= 0:
        logger.info(f"reminder_skip: already_in_past")
        continue  # –ù–µ –ø–ª–∞–Ω–∏—Ä—É–µ–º
    
    task = asyncio.create_task(_send_reminder(...))
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
- "24h" –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –∑–∞–≤—Ç—Ä–∞
- "1h" –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å —Å–µ–≥–æ–¥–Ω—è (–∑–∞ —á–∞—Å –¥–æ –≤—Ä–µ–º–µ–Ω–∏)
- –û–±–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Ä–µ–º—è –µ—â–µ –Ω–µ –ø—Ä–æ—à–ª–æ ‚úÖ

---

### 5Ô∏è‚É£ üìã –í –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è ID

**–ü—Ä–æ–±–ª–µ–º–∞:** 
```
–£—Å–ª—É–≥–∞ ID: 3
–ú–∞—Å—Ç–µ—Ä ID: 2
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ repo
service = await get_service(data['service_id'])
service_name = service['name']

master_id = data['master_id']
master_name = '–±–µ–∑ –≤—ã–±–æ—Ä–∞'
if master_id:
    master = await get_master(master_id)
    master_name = master['name']

# –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
text = f"""
–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–ø–∏—Å—å:
–£—Å–ª—É–≥–∞: {service_name}
–ú–∞—Å—Ç–µ—Ä: {master_name}
–î–∞—Ç–∞: {data['date']}
–í—Ä–µ–º—è: {data['time']}
...
"""
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞, –ë–ï–ó ID ‚úÖ

---

### 6Ô∏è‚É£ üë®‚Äçüîß –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞ ‚Üí –≤—ã–±–æ—Ä —É—Å–ª—É–≥

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–∞—Å—Ç–µ—Ä–∞ –Ω–µ–ª—å–∑—è –≤—ã–±—Ä–∞—Ç—å, –≤ –∫–∞–∫–∏—Ö —É—Å–ª—É–≥–∞—Ö –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω —à–∞–≥ `services` –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞:

```
FSM —à–∞–≥–∏:
name ‚Üí bio ‚Üí contact ‚Üí services ‚Üí confirm ‚Üí create

–£—Å–ª–æ–≤–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è inline –∫–Ω–æ–ø–∫–∞–º–∏ –ø–æ 5 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:
[–ú–∞—Å—Å–∞–∂ ‚Äî 30‚Ç¨] [–°—Ç—Ä–∏–∂–∫–∞ ‚Äî15‚Ç¨] ...
[‚úÖ –ì–æ—Ç–æ–≤–æ]
```

**Callback —Ñ–æ—Ä–º–∞—Ç:** `admin:master:add:service:{service_id}`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤—ã–±–∏—Ä–∞–µ—Ç —É—Å–ª—É–≥–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–∞—Å—Ç–µ—Ä–∞ ‚úÖ

---

## üìù –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ 63 —Ç–µ—Å—Ç–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ:

```bash
$ python -m pytest -q
63 passed, 1 warning in 9.39s
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:**
- `TestTaskScheduling::test_cancel_scheduled_task` - –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –±—É–¥—É—â–µ–π –¥–∞—Ç—ã

---

## üèóÔ∏è –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `app/handlers/booking.py` | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–∞—Ä—Å–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏, –ø–æ–∫–∞–∑ –∏–º–µ–Ω –≤ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ |
| `app/scheduler.py` | –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–µ–¥—à–∏—Ö —Å–ª–æ—Ç–æ–≤ –≤ `generate_slots()` |
| `app/auto_complete.py` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –±—É–¥—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–µ—Ä–µ–¥ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º |
| `app/reminders.py` | –ü—Ä–æ–ø—É—Å–∫ –ø—Ä–æ—à–µ–¥—à–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è |
| `app/handlers/admin.py` | –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–±–æ—Ä —É—Å–ª—É–≥ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∞—Å—Ç–µ—Ä–∞ |
| `tests/test_auto_complete.py` | –û–±–Ω–æ–≤–ª–µ–Ω —Ç–µ—Å—Ç –¥–ª—è –±—É–¥—É—â–µ–π –¥–∞—Ç—ã |

---

## ‚úÖ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

- ‚úÖ –í—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ `HH:MM` —Å—Ç—Ä–æ–∫–∞
- ‚úÖ –ü—Ä–æ—à–µ–¥—à–∏–µ —Å–ª–æ—Ç—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è
- ‚úÖ –ê–≤—Ç–æ–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
- ‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∏–º–µ–Ω–∞ –≤–º–µ—Å—Ç–æ ID
- ‚úÖ –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–∞—Å—Ç–µ—Ä–∞ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —É—Å–ª—É–≥–∏
- ‚úÖ aiogram 3.x –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
- ‚úÖ –ù–æ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
- ‚úÖ –í—Å—ë –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

---

## üöÄ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
python -m pytest -q

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å –ª–æ–≥–∞–º–∏
python -m pytest -xvs tests/test_booking_date_flow.py

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–ø–µ—Ü—Ç–µ—Å—Ç—ã
python -m pytest tests/test_auto_complete_e2e.py -xvs
```
